@using SIMS.Core;
@using SIMS.API;
@page "/users"
@rendermode InteractiveServer 
@inject NavigationManager Navigation
@inject LoginState UserState
@inject HttpClient Http


@* 
@if (!UserState.IsLoggedIn)
{
    Navigation.NavigateTo("/account/login", true);
    <div>Umleitung zum Login...</div>
    return;
} *@

@if (showRedirectMessage)
{
    <div class="alert alert-info">
        <p>Sie sind nicht angemeldet. Weiterleitung zum Login...</p>
    </div>
}
else
{
    @* wenn eingeloggt, geschützte Seite anzeigen *@
    

<h3>Benutzerverwaltung</h3>

@* Benachrichtigung für User, das sie nur daten laden aber nicht ändern können. *@
@if (UserState.Role == RoleType.User)
{
    <div style="color: #555; background: #eef; padding: 6px 12px; border-radius: 6px; margin-bottom: 8px;">
        Du kannst nur ansehen, nicht bearbeiten.
    </div>
}

@*Buttons für Datenladung*@
<button @onclick="LoadMockData">Nur Frontend testen (Dummy-Daten laden)</button>
<button @onclick="LoadUsers">Backend/Live-Daten laden</button>

@if (users == null)
{
    <p>Lade Benutzer ...</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Id</th>
                <th>Username</th>
                <th>Rolle</th>
                <th>Status</th>
                <th>Aktion</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in users)
            {
                <tr>
                    <td>@user.Id</td>
                    <td>@user.Username</td>
                    <td>@user.Role</td>
                    <td>@(user.Enabled ? "Aktiv" : "Inaktiv")</td>
                    <td>
                        @*Wenn role als admin dann können user aktiviert oder deaktiviert werden*@
                        @if (UserState.Role == RoleType.Admin)
                        {  
                            @if (user.Enabled)
                        {
                            <button @onclick="() => SetEnabled(user.Id, false)">Deaktivieren</button>
                        }
                        else
                        {
                            <button @onclick="() => SetEnabled(user.Id, true)">Aktivieren</button>
                        }
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @*neue User können nur Benutzer die als Rolle admin haben*@
    @if (UserState.Role == RoleType.Admin)
    {
        <hr />    <h4>Neuen User anlegen</h4>    <input @bind="newUser.Username" placeholder="Username" />
        <input @bind="newUser.PasswordHash" type="password" placeholder="Passwort" />
        <input @bind="newUser.Email" placeholder="Email" />    <select @bind="newUser.Role">
            <option value="Admin">Admin</option>
            <option value="User">User</option>
        </select>
        <button @onclick="AddUser">Speichern</button>
    }
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div style="color: red; margin-top: 10px;">@errorMessage</div>
    }
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div style="color: green; margin-top: 10px;">@successMessage</div>
    }
}

}
@code {

   private bool showRedirectMessage = false;

    protected override void OnInitialized()
    {
        if (!UserState.IsLoggedIn)
        {
            showRedirectMessage = true;
            Navigation.NavigateTo("/account/login", true);
        }
    }

    // protected override void OnAfterRender(bool firstRender)
    // {
    //     if (firstRender && !UserState.IsLoggedIn)
    //     {
    //         Navigation.NavigateTo("/account/login", true);
    //     }
    // }

    private List<User> users;
    private User newUser = new();
    private string errorMessage = "";
    private string successMessage = "";

    @* Code für Sync von eingespeichert daten aus SQL*@
    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadUsers();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler: {ex.Message}";
            LoadMockData();
        }
    }

    @* Code für Laden von eingespeichert daten aus SQL*@
    private async Task LoadUsers()
    {
        try
        {
            errorMessage = "";
            successMessage = "";
            users = await Http.GetFromJsonAsync<List<User>>("api/Users");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Backend-Fehler: {ex.Message}";
        }
    }
    @* Code für Laden von Dummydaten*@
    private void LoadMockData()
    {
        users = new List<User>
        {
            new User { Id = 1, Username = "alice", Email = "alice@ustp-students.at", Role = "Admin", Enabled = true, PasswordHash = "pw1" },
            new User { Id = 2, Username = "bob", Email = "bob@ustp-students.at", Role = "User", Enabled = false, PasswordHash = "pw2" }
        };
        successMessage = "Dummy-Daten geladen";
        StateHasChanged();
    }

    @* Code für neue User anlegen und an SQL senden*@
    async Task AddUser()
    {
        errorMessage = "";
        successMessage = "";

        if (IsDummy())
        {
            var nextId = users.Any() ? users.Max(u => u.Id) + 1 : 1;
            var localUser = new User
            {
                Id = nextId,
                Username = newUser.Username,
                PasswordHash = newUser.PasswordHash,
                Email = newUser.Email,
                Role = newUser.Role,
                Enabled = true
            };
            users.Add(localUser);
            newUser = new();
            successMessage = "User (Dummy) hinzugefügt";
            StateHasChanged();
            return;
        }

        try
        {
            var response = await Http.PostAsJsonAsync("api/Users", newUser);
            if (response.IsSuccessStatusCode)
            {
                await LoadUsers();
                newUser = new();
                successMessage = "User erfolgreich hinzugefügt";
            }
            else
            {
                errorMessage = $"Fehler: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Hinzufügen: {ex.Message}";
        }
    }

        @* Code für aktivieren von Usern*@
    async Task SetEnabled(int userId, bool enabled)
    {
        errorMessage = "";
        successMessage = "";

        if (IsDummy())
        {
            var user = users.FirstOrDefault(u => u.Id == userId);
            if (user != null) user.Enabled = enabled;
            successMessage = $"User {userId} (Dummy) {(enabled ? "aktiviert" : "deaktiviert")}";
            StateHasChanged();
            return;
        }

        try
        {
            var patchData = new { enabled = enabled };
            var response = await Http.PatchAsJsonAsync($"api/Users/{userId}/enabled", patchData);
            
            if (response.IsSuccessStatusCode)
            {
                await LoadUsers();
                successMessage = $"User {userId} erfolgreich {(enabled ? "aktiviert" : "deaktiviert")}";
            }
            else
            {
                errorMessage = $"Fehler: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Aktualisieren: {ex.Message}";
        }
    }

    private bool IsDummy() => users?.FirstOrDefault()?.Email?.EndsWith("@fh.at") ?? false;

  
}
