@page "/home"
@using SIMS.API
@using SIMS.Core
@using SIMS.Core.Classes
@inject NavigationManager Navigation
@inject LoginState UserState
@inject HttpClient Http
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime


@if (isValidatingSession)
{
    <div class="alert alert-info">
        <p>Session wird validiert...</p>
    </div>
}
else if (!UserState.IsLoggedIn)
{
    <div class="alert alert-warning">
        <p>Sie sind nicht angemeldet. Weiterleitung zum Login...</p>
    </div>
}
else
{
<PageTitle>Home</PageTitle>
   @* Header mit User-Info und Logout-Button*@
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px; background: #f5f5f5; border-radius: 6px;">
        <div>
            <h3 style="margin: 0;">Startseite</h3>
            <small>Eingeloggt als: <strong>@UserState.Username</strong> (@UserState.Role)</small>
        </div>
        <button @onclick="Logout" class="btn btn-danger">Logout</button>
    </div>
            <p style="font-size:1.25rem;">
        Willkommen im modernen <strong>Security-Incident-Management-System – SIMS!</strong><br />
        Hier hast du die Kontrolle:<br />
        <b>Benutzer</b> blitzschnell aktivieren, deaktivieren und neu anlegen<br />
        <b>Incidents</b> effizient erfassen, bearbeiten, weiterleiten oder löschen<br />
        Mit SIMS wird Management zum Erlebnis – <b>Sicherheit</b> und <b>Übersicht</b> im stylishen Look!
    </p>

@code {
      private bool isValidatingSession = true;
       private string errorMessage = "";
    private string successMessage = "";


     protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Console.WriteLine("OnAfterRenderAsync - firstRender");

            //Session aus browser laden        
            var loaded = await UserState.LoadFromStorage();
            Console.WriteLine($"LoadFromStorage result: {loaded}");
            Console.WriteLine($"SessionId: {UserState.SessionId}");
            Console.WriteLine($"Username: {UserState.Username}");

            if (!loaded || string.IsNullOrEmpty(UserState.SessionId))
            {
                Console.WriteLine("Keine gespeicherte Session - Weiterleitung zum Login");
                // showRedirectMessage = true;
                Navigation.NavigateTo("/account/login", forceLoad: true);
                return;
            }

            // Session beim Backend validieren
            try
            {
                Console.WriteLine($"Validiere Session: {UserState.SessionId}");
                var response = await Http.GetAsync($"/api/login/validate?sessionId={UserState.SessionId}");

                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<SessionValidationResponse>();

                    if (result != null && result.Success)
                    {
                        Console.WriteLine($"Session gültig für User: {UserState.Username}");
                        isValidatingSession = false;
                        StateHasChanged();
                    }
                    else
                    {
                        Console.WriteLine("Session ungültig - Logout");
                         isValidatingSession = false;
                        await UserState.ClearStorage();
                        Navigation.NavigateTo("/account/login", forceLoad: true);
                    }
                }
                else
                {
                    Console.WriteLine($"Session-Validierung fehlgeschlagen: {response.StatusCode}");
                    await UserState.ClearStorage();
                    Navigation.NavigateTo("/account/login", forceLoad: true);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Fehler bei Session-Validierung: {ex.Message}");
                errorMessage = $"Fehler beim Laden: {ex.Message}";
                isValidatingSession = false;
                StateHasChanged();
            }
        }
    }

    private async Task Logout()
    {
        try
        {
            
            await UserState.ClearStorage();
            Navigation.NavigateTo("/account/login", forceLoad: true);
        }
        catch
        {
            await UserState.ClearStorage();
            Navigation.NavigateTo("/account/login", forceLoad: true);
        }
    }
        public class SessionValidationResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; }
        public UserInfo User { get; set; }
    }

    public class UserInfo
    {
        public int Id { get; set; }
        public string Username { get; set; }
        public string Role { get; set; }
    }
}
}