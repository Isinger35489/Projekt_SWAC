@using SIMS.API;
@using SIMS.Core;
@using SIMS.Core.Classes
@page "/users"
@rendermode InteractiveServer 
@inject NavigationManager Navigation
@inject LoginState UserState
@inject HttpClient Http

@if (isValidatingSession)
{
    <div class="alert alert-info">
        <p>Session wird validiert...</p>
    </div>
}
else if (!UserState.IsLoggedIn)
{
    <div class="alert alert-warning">
        <p>Sie sind nicht angemeldet. Weiterleitung zum Login...</p>
    </div>
}
else
{
   @* Header mit User-Info und Logout-Button*@
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px; background: #f5f5f5; border-radius: 6px;">
        <div>
            <h3 style="margin: 0;">Benutzerverwaltung</h3>
            <small>Eingeloggt als: <strong>@UserState.Username</strong> (@UserState.Role)</small>
        </div>
        <button @onclick="Logout" class="btn btn-danger">Logout</button>
    </div>
 

@* 
@if (!UserState.IsLoggedIn)
{
    Navigation.NavigateTo("/account/login", true);
    <div>Umleitung zum Login...</div>
    return;
} *@
@* 
@if (showRedirectMessage)
{
    <div class="alert alert-info">
        <p>Sie sind nicht angemeldet. Weiterleitung zum Login...</p>
    </div>
}
else *@
@*
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px; background: #f5f5f5; border-radius: 6px;">
        <div>
            <h3 style="margin: 0;">Benutzerverwaltung</h3>
            <small>Eingeloggt als: <strong>@UserState.Username</strong> (@UserState.Role)</small>
        </div>
        <button @onclick="Logout" class="btn btn-danger">Logout</button>
    </div>  *@
    @* wenn eingeloggt, geschützte Seite anzeigen *@
    

@* <h3>Benutzerverwaltung</h3> *@

@* Benachrichtigung für User, das sie nur daten laden aber nicht ändern können. *@
@if (UserState.Role == RoleType.User)
{
    <div style="color: #555; background: #eef; padding: 6px 12px; border-radius: 6px; margin-bottom: 8px;">
        Du kannst nur ansehen, nicht bearbeiten.
    </div>
}

@*Buttons für Datenladung*@
<button @onclick="LoadMockData">Nur Frontend testen (Dummy-Daten laden)</button>
<button @onclick="LoadUsers">Backend/Live-Daten laden</button>

@if (users == null)
{
    <p>Lade Benutzer ...</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Id</th>
                <th>Username</th>
                <th>Rolle</th>
                <th>Status</th>
                <th>Aktion</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in users)
            {
                <tr>
                    <td>@user.Id</td>
                    <td>@user.Username</td>
                    <td>@user.Role</td>
                    <td>@(user.Enabled ? "Aktiv" : "Inaktiv")</td>
                    <td>
                        @*Wenn role als admin dann können user aktiviert oder deaktiviert werden*@
                        @if (UserState.Role == RoleType.Admin)
                        {  
                            @if (user.Enabled)
                        {
                            <button @onclick="() => SetEnabled(user.Id, false)">Deaktivieren</button>
                        }
                        else
                        {
                            <button @onclick="() => SetEnabled(user.Id, true)">Aktivieren</button>
                        }
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @*neue User können nur Benutzer die als Rolle admin haben*@
    @if (UserState.Role == RoleType.Admin)
    {
        <hr />    <h4>Neuen User anlegen</h4>    <input @bind="newUser.Username" placeholder="Username" />
        <input @bind="newUser.PasswordHash" type="password" placeholder="Passwort" />
        <input @bind="newUser.Email" placeholder="Email" />    <select @bind="newUser.Role">
            <option value="Admin">Admin</option>
            <option value="User">User</option>
        </select>
        <button @onclick="AddUser">Speichern</button>
    }
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div style="color: red; margin-top: 10px;">@errorMessage</div>
    }
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div style="color: green; margin-top: 10px;">@successMessage</div>
    }
}

}
@code {

    private bool isValidatingSession = true;
    private List<User> users;
    private User newUser = new();
    private string errorMessage = "";
    private string successMessage = "";

   // private bool showRedirectMessage = false;

   //  protected override void OnInitialized()
   //  {
   //      if (!UserState.IsLoggedIn)
   //      {
   //          showRedirectMessage = true;
   //          //Navigation.NavigateTo("/account/login", true);

   //      }
   //  }

   //  protected override void OnAfterRender(bool firstRender)
   //  {
   //      if (firstRender && !UserState.IsLoggedIn)
   //      {
   //          Navigation.NavigateTo("/account/login", true);
   //      }


   //  }
     protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Console.WriteLine("OnAfterRenderAsync - firstRender");

            //Session aus browser laden        
            var loaded = await UserState.LoadFromStorage();
            Console.WriteLine($"LoadFromStorage result: {loaded}");
            Console.WriteLine($"SessionId: {UserState.SessionId}");
            Console.WriteLine($"Username: {UserState.Username}");

            if (!loaded || string.IsNullOrEmpty(UserState.SessionId))
            {
                Console.WriteLine("Keine gespeicherte Session - Weiterleitung zum Login");
                // showRedirectMessage = true;
                Navigation.NavigateTo("/account/login", forceLoad: true);
                return;
            }

            // Session beim Backend validieren
            try
            {
                Console.WriteLine($"Validiere Session: {UserState.SessionId}");
                var response = await Http.GetAsync($"/api/login/validate?sessionId={UserState.SessionId}");

                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<SessionValidationResponse>();

                    if (result != null && result.Success)
                    {
                        Console.WriteLine($"Session gültig für User: {UserState.Username}");
                        isValidatingSession = false;

                        // Incidents laden
                        await LoadUsers();
                        StateHasChanged();
                    }
                    else
                    {
                        Console.WriteLine("Session ungültig - Logout");
                        await UserState.ClearStorage();
                        Navigation.NavigateTo("/account/login", forceLoad: true);
                    }
                }
                else
                {
                    Console.WriteLine($"Session-Validierung fehlgeschlagen: {response.StatusCode}");
                    await UserState.ClearStorage();
                    Navigation.NavigateTo("/account/login", forceLoad: true);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Fehler bei Session-Validierung: {ex.Message}");
                errorMessage = $"Fehler beim Laden: {ex.Message}";
                await LoadMockData();
                isValidatingSession = false;
                StateHasChanged();
            }
        }
    }
    @* Logout-Methode *@
    private async Task Logout()
    {
        try
        {
            // Optional: Backend über Logout informieren
            // await Http.PostAsync($"/api/login/logout?sessionId={UserState.SessionId}", null);
            
            await UserState.ClearStorage();
            Console.WriteLine("Logout erfolgreich");
            Navigation.NavigateTo("/account/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fehler beim Logout: {ex.Message}");
            await UserState.ClearStorage();
            Navigation.NavigateTo("/account/login", forceLoad: true);
        }
    }



  

    //   @* Logout-Methode *@
    // private async Task Logout()
    // {
    //     try
    //     {
    //         await UserState.ClearStorage();
    //         Console.WriteLine("Logout erfolgreich");
    //         Navigation.NavigateTo("/account/login", forceLoad: true);
    //     }
    //     catch (Exception ex)
    //     {
    //         Console.WriteLine($"Fehler beim Logout: {ex.Message}");
    //         await UserState.ClearStorage();
    //         Navigation.NavigateTo("/account/login", forceLoad: true);
    //     }
    // }

    @* Code für Sync von eingespeichert daten aus SQL*@
    // protected override async Task OnInitializedAsync()
    // {
    //     try
    //     {
    //         await LoadUsers();
    //     }
    //     catch (Exception ex)
    //     {
    //         errorMessage = $"Fehler: {ex.Message}";
    //         LoadMockData();
    //     }
    // }

    @* Code für Laden von eingespeichert daten aus SQL*@
    private async Task LoadUsers()
    {
        try
        {
            errorMessage = "";
            successMessage = "";
            users = await Http.GetFromJsonAsync<List<User>>("api/Users");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Backend-Fehler: {ex.Message}";
        }
    }
    @* Code für Laden von Dummydaten*@
    // private void LoadMockData()
    private Task LoadMockData()
    {
        users = new List<User>
        {
            new User { Id = 1, Username = "alice", Email = "alice@ustp-students.at", Role = "Admin", Enabled = true, PasswordHash = "pw1" },
            new User { Id = 2, Username = "bob", Email = "bob@ustp-students.at", Role = "User", Enabled = false, PasswordHash = "pw2" }
        };
        successMessage = "Dummy-Daten geladen";
        StateHasChanged();
        return Task.CompletedTask;
    }

    @* Code für neue User anlegen und an SQL senden*@
    async Task AddUser()
    {
        errorMessage = "";
        successMessage = "";

        if (IsDummy())
        {
            var nextId = users.Any() ? users.Max(u => u.Id) + 1 : 1;
            var localUser = new User
            {
                Id = nextId,
                Username = newUser.Username,
                PasswordHash = newUser.PasswordHash,
                Email = newUser.Email,
                Role = newUser.Role,
                Enabled = true,
                CreatedAt = DateTime.Now
            };
            users.Add(localUser);
            newUser = new();
            successMessage = "User (Dummy) hinzugefügt";
            StateHasChanged();
            return;
        }

        try
        {

            newUser.CreatedAt = DateTime.Now;
            newUser.Enabled = true;

            var response = await Http.PostAsJsonAsync("api/Users", newUser);
            if (response.IsSuccessStatusCode)
            {
                await LoadUsers();
                newUser = new();
                successMessage = "User erfolgreich hinzugefügt";
            }
            else
            {
                errorMessage = $"Fehler: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Hinzufügen: {ex.Message}";
        }
    }

        @* Code für aktivieren von Usern*@
    async Task SetEnabled(int userId, bool enabled)
    {
        errorMessage = "";
        successMessage = "";

        if (IsDummy())
        {
            var user = users.FirstOrDefault(u => u.Id == userId);
            if (user != null) user.Enabled = enabled;
            successMessage = $"User {userId} (Dummy) {(enabled ? "aktiviert" : "deaktiviert")}";
            StateHasChanged();
            return;
        }

        try
        {
            var patchData = new { enabled = enabled };
            var response = await Http.PatchAsJsonAsync($"api/Users/{userId}/enabled", patchData);
            
            if (response.IsSuccessStatusCode)
            {
                await LoadUsers();
                successMessage = $"User {userId} erfolgreich {(enabled ? "aktiviert" : "deaktiviert")}";
            }
            else
            {
                errorMessage = $"Fehler: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Aktualisieren: {ex.Message}";
        }
    }

    private bool IsDummy() => users?.FirstOrDefault()?.Email?.EndsWith("@fh.at") ?? false;
     public class SessionValidationResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; }
        public UserInfo User { get; set; }
    }

    public class UserInfo
    {
        public int Id { get; set; }
        public string Username { get; set; }
        public string Role { get; set; }
    }
  
}
