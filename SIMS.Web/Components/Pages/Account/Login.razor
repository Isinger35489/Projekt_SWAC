@page "/account/login"
@inject HttpClient Http
@inject LoginState UserState
@inject NavigationManager Navigation
@rendermode InteractiveServer 
@* @rendermode @(new InteractiveServerRenderMode(prerender: false)) *@
@using SIMS.Core;
@using SIMS.Core.Classes;
@using System.ComponentModel.DataAnnotations

<h3>Login</h3>
@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@* Formular für login *@
@*1ste variante*@
@* <EditForm Model="credential" OnValidSubmit="DoLogin" FormName="login-form">
    <DataAnnotationsValidator /> *@
   @*  <ValidationSummary />
    <div>
        <label>User Name:</label>
        <InputText @bind-Value="credential.UserName" />
        <ValidationMessage For="@(() => credential.UserName)" />
    </div>
    <div>
        <label>Password:</label>
        <InputText @bind-Value="credential.Password" type="password" />
        <ValidationMessage For="@(() => credential.Password)" />
    </div>
    <button type="submit">Login</button>
</EditForm> *@

@*2 variante *@

<EditForm Model="credential" OnValidSubmit="DoLogin">
    <DataAnnotationsValidator />
    
    <div class="form-group">
        <label>User Name:</label>
        <InputText @bind-Value="credential.Username" class="form-control" />
        <ValidationMessage For="@(() => credential.Username)" />
    </div>
    
    <div class="form-group">
        <label>Password:</label>
<InputText @bind-Value="credential.Password" type="password" class="form-control" />
        <ValidationMessage For="@(() => credential.Password)" />
    </div>
    
  @*   <button type="submit" class="btn btn-primary">Login</button> *@
  <button type="submit" class="btn btn-primary" disabled="@isLoggingIn">
        @if (isLoggingIn)
        {
            <span>Login läuft...</span>
        }
        else
        {
            <span>Login</span>
        }
    </button>
</EditForm>


@* Codeblock für login *@

@code {
    private Credential credential = new();
    private string errorMessage;
    private string successMessage;
     private bool isLoggingIn = false;
    //  public bool IsLoggedIn => !string.IsNullOrEmpty(Username) && !string.IsNullOrEmpty(SessionId);
    // // public bool IsLoggedIn => !string.IsNullOrEmpty(Username) && !string.IsNullOrEmpty(SessionId);


    private async Task DoLogin()
    {
        errorMessage = "";
        successMessage = "";
         isLoggingIn = true;
 

        // //zum testen ist man dauernd als admin eingeloggt
        //     UserState.Username = "admin";
        //     UserState.Role = RoleType.Admin;
        //     Navigation.NavigateTo("/home");

        //senden an Logindatn an API
        try
        {
        var response = await Http.PostAsJsonAsync("/api/login", credential); //generalisiert URL damits weniger progbleme macht

        if (response.IsSuccessStatusCode)
        {
            // Erfolg: Token lesen
            var result = await response.Content.ReadFromJsonAsync<LoginResponse>(); //holt sich die Antwort von der API

            if (result != null && result.Success)
            {
                // holt sich API Userinfos aus der API und schreibt sie in die Webapp klasse UserState
                UserState.Id = result.User.Id;
                UserState.Username = result.User.Username;
                UserState.SessionId = result.SessionId;
        

                // Parse role from string to RoleType enum
                UserState.Role = result.User.Role.ToLower() == "admin"
                    ? RoleType.Admin
                    : RoleType.User;

                       Console.WriteLine($"Login erfolgreich für User: {result.User.Username}, Session: {result.SessionId}");

                    //speichert die session im browser
                    await UserState.SaveToStorage();
                    Console.WriteLine("Session im Browser gespeichert");
                    successMessage = "Login erfolgreich! Weiterleitung...";
                
                    StateHasChanged();
                await Task.Delay(500);  // Short delay to show success message

                Navigation.NavigateTo("/home", forceLoad: true);
            }
            else
            {
                errorMessage = result?.Message ?? "Login fehlgeschlagen";
                Console.WriteLine($"Login fehlgeschlagen: {errorMessage}");
            }
            //Console.WriteLine($"Login erfolgreich, Token: {token}");
        }
        else
        {
            // Handle error responses
            try
            {
                var error = await response.Content.ReadFromJsonAsync<LoginResponse>();
                errorMessage = error?.Message ?? "Ungültiger Benutzername oder Passwort";
            }
            catch
            {
                errorMessage = "Ungültiger Benutzername oder Passwort";
            }

            Console.WriteLine($"API Fehler: {response.StatusCode}");
        }
    }
      catch (Exception ex)
        {
            errorMessage = $"Fehler: {ex.Message}";
            Console.WriteLine($"Exception beim Login: {ex}");
        }
        finally
        {
            isLoggingIn = false;
        }
    }

  
      public class Credential
    {
        [Required(ErrorMessage = "Benutzername ist erforderlich.")]
        [Display(Name = "User Name")]
        public string Username { get; set; } = string.Empty;
        
        [Required(ErrorMessage = "Passwort ist erforderlich.")]
        [DataType(DataType.Password)]
        public string Password { get; set; } = string.Empty;
    }
}
